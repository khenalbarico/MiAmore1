@using System.IO
@using System.Text.Json
@using System.Globalization
@using LogicLbrary1.Models.Gallery
@inject IWebHostEnvironment Env

<div class="g-wrap">
    <div class="g-body">
        <h2 class="g-title">Monthly Highlights</h2>

        <div class="months">
            @for (int i = 0; i < _months.Count; i++)
            {
                var m = _months[i];
                <div class="month-tile" style="--d:@(i * 55)ms" @onclick="() => Open(m)">
                    @{
                        var p = m.Items.Take(4).ToList();
                        var cls = $"collage c{Math.Min(4, p.Count)}";
                    }

                    <div class="pink-card">
                        <div class="thumb">
                            <div class="@cls">
                                @foreach (var it in p)
                                {
                                    <div class="cell">
                                        @if (it.IsVideo)
                                        {
                                            <video class="media" muted loop playsinline>
                                                <source src="@it.WebPath" type="video/mp4" />
                                            </video>
                                        }
                                        else
                                        {
                                            <img class="media" src="@it.WebPath" />
                                        }
                                    </div>
                                }
                            </div>

                            <div class="thumb-overlay">
                                <div class="thumb-title">@m.Name</div>
                                <div class="thumb-sub">@m.Items.Count item(s)</div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@if (_open && _active is not null)
{
    <div class="g-backdrop" @onclick="Close">
        <div class="g-modal romantic" @onclick:stopPropagation="true">
            <button class="g-close-btn" @onclick="Close">✕</button>

            <div class="g-modal-content @(_active.Items.Count == 1 ? "single" : "multi")">
                <div class="media-grid">
                    @for (int i = 0; i < _active.Items.Count; i++)
                    {
                        var it = _active.Items[i];
                        <div class="media-box" style="--md:@(i * 45)ms">
                            @if (it.IsVideo)
                            {
                                <video src="@it.WebPath" controls></video>
                            }
                            else
                            {
                                <img src="@it.WebPath" />
                            }
                        </div>
                    }
                </div>

                <div class="message-box">
                    <h3>@_active.Name</h3>
                    <p>@_active.Model.Message</p>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<MonthGallery> _months = new();
    private MonthGallery? _active;
    private bool _open;
    private Dictionary<(int Year, int Month), string> _messages = new();

    protected override void OnInitialized()
    {
        LoadMessages();
        LoadGallery();
    }

    void LoadMessages()
    {
        var path = Path.Combine(AppContext.BaseDirectory, "GetGalleryMessages.json");
        if (!File.Exists(path)) return;

        var json = File.ReadAllText(path);
        var data = JsonSerializer.Deserialize<List<GalleryMessageYear>>(json)!;

        foreach (var y in data)
        {
            foreach (var m in y.Months)
            {
                var month = DateTime.ParseExact(m.Key, "MMMM", CultureInfo.InvariantCulture).Month;
                _messages[(int.Parse(y.Year), month)] = m.Value;
            }
        }
    }

    void LoadGallery()
    {
        var root = Path.Combine(Env.WebRootPath, "images", "monthHighlights");
        if (!Directory.Exists(root)) return;

        _months = Directory.GetDirectories(root)
            .Select(dir =>
            {
                var name = Path.GetFileName(dir);
                if (!DateTime.TryParseExact(name, "MMMM yyyy", CultureInfo.InvariantCulture, DateTimeStyles.None, out var date))
                    return null;

                var items = Directory.GetFiles(dir)
                    .Where(f => new[] { ".jpg", ".jpeg", ".mp4" }.Contains(Path.GetExtension(f).ToLower()))
                    .Select(f => new MediaItem(
                        $"/images/monthHighlights/{name}/{Path.GetFileName(f)}",
                        Path.GetExtension(f).Equals(".mp4", StringComparison.OrdinalIgnoreCase)))
                    .ToList();

                if (!items.Any()) return null;

                _messages.TryGetValue((date.Year, date.Month), out var msg);

                return new MonthGallery(
                    date.ToString("MMMM yyyy"),
                    date,
                    items,
                    new BaseModelGallery { Message = msg ?? "" });
            })
            .Where(x => x != null)
            .OrderByDescending(x => x!.Date)
            .ToList()!;
    }

    void Open(MonthGallery m)
    {
        _active = m;
        _open = true;
    }

    void Close()
    {
        _open = false;
        _active = null;
    }

    record GalleryMessageYear(string Year, Dictionary<string, string> Months);
    record MonthGallery(string Name, DateTime Date, List<MediaItem> Items, BaseModelGallery Model);
    record MediaItem(string WebPath, bool IsVideo);
}
